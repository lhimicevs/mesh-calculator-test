<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Калькулятор сварной сетки — test (фикс. шаг, выпуски=убираем стержни)</title>
  <style>
    :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7f9; color: #111; }
    header { padding: 14px 16px 10px; background: #fff; border-bottom: 1px solid #e7e7e7; position: sticky; top: 0; z-index: 10; }
    h1 { margin: 0; font-size: 18px; }
    .wrap { max-width: 1080px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border:1px solid #e7e7e7; border-radius:12px; padding:14px; box-shadow:0 1px 0 rgba(0,0,0,.02); }
    .grid { display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width: 920px) { .grid.two { grid-template-columns:1fr 1fr; } }
    label { display:block; font-size:12px; color:#333; margin-bottom:4px; }
    input, select { width:100%; box-sizing:border-box; padding:10px; border-radius:10px; border:1px solid #d7d7d7; font-size:14px; background:#fff; }
    input:focus, select:focus { outline:2px solid #cfe3ff; border-color:#7fb1ff; }
    select:disabled { background:#f2f3f5; color:#777; }
    .hint { font-size:12px; color:#666; margin-top:6px; line-height:1.35; }
    .err { font-size:12px; color:#b00020; margin-top:6px; }
    .warn { font-size:12px; color:#7a4b00; margin-top:6px; line-height:1.35; }
    .ok { color:#0a6b2b; }
    .btns { display:grid; grid-template-columns:1fr; gap:10px; margin-top:12px; }
    @media (min-width: 640px) { .btns { grid-template-columns: 1fr 1fr 1fr 1fr; } }
    button { padding:12px; border-radius:10px; border:1px solid #d7d7d7; background:#fff; font-size:14px; cursor:pointer; }
    button.primary { background:#111; color:#fff; border-color:#111; }
    .results { margin-top:14px; display:none; }
    .sectionTitle { font-size:14px; font-weight:600; margin:0 0 10px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .kv { display:grid; grid-template-columns:1fr auto; gap:8px 12px; font-size:14px; }
    .k { color:#333; }
    .v { font-variant-numeric: tabular-nums; text-align:right; }
    .note { margin-top:10px; font-size:12px; color:#666; line-height:1.35; }
    details { margin-top:10px; }
    summary { cursor:pointer; color:#444; font-size:13px; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }
    .topControls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .toggle { display:flex; gap:8px; align-items:center; }
    .toggle input { width:auto; }
    .mini { font-size:12px; color:#666; }

    .stickyBar {
      position: sticky; bottom: 0; z-index: 9;
      background: rgba(246,247,249,.95); backdrop-filter: blur(6px);
      border-top: 1px solid #e7e7e7;
      padding: 10px 16px;
    }
    .stickyInner { max-width: 1080px; margin: 0 auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .stickyInner button { padding:10px 12px; }
    .stickyInner .mini { flex:1; min-width:240px; }
    @media (min-width: 920px) { .stickyBar { display:none; } }

    .hr { border:none; border-top:1px solid #eee; margin:14px 0; }

    .pill { display:inline-block; padding:3px 8px; border-radius:999px; background:#f0f2f5; border:1px solid #e2e4e8; font-size:12px; color:#444; margin:2px 6px 2px 0; }
    .pillsWrap { margin-top: 8px; }
  </style>
</head>

<body>
<header>
  <h1>Калькулятор сварной арматурной сетки <span class="pill">test</span></h1>
  <div class="mini" style="margin-top:6px;">
    Шаг фиксированный (машина). Под выпуски — только уменьшаем количество стержней.
  </div>
</header>

<div class="wrap">
  <div class="card">

    <div class="topControls">
      <div class="toggle">
        <strong style="font-size:12px;color:#333;">Единицы ввода:</strong>
        <label class="toggle mini"><input type="radio" name="u" value="mm" checked> мм</label>
        <label class="toggle mini"><input type="radio" name="u" value="m"> м</label>
      </div>

      <div class="toggle">
        <label class="toggle mini"><input id="autoCalc" type="checkbox" checked> автопересчёт</label>
      </div>

      <div class="mini">
        Удельные веса (кг/м): Ø6=0.222 • Ø8=0.395 • Ø10=0.616 • Ø12=0.888
      </div>
    </div>

    <div class="grid two" style="margin-top:12px;">

      <div>
        <div class="sectionTitle">Геометрия карты</div>
        <div class="grid two">
          <div>
            <label for="W">W (ось Y), <span data-unit-label="len">мм</span></label>
            <input id="W" type="number" inputmode="decimal" min="0" step="50" placeholder="1200…2350">
            <div class="hint">ТЗ: 1200 ≤ W ≤ 2350 мм</div>
            <div id="errW" class="err"></div>
          </div>
          <div>
            <label for="L">L (ось X), <span data-unit-label="len">мм</span></label>
            <input id="L" type="number" inputmode="decimal" min="0" step="50" placeholder="1000…6000">
            <div class="hint">ТЗ: 1000 ≤ L ≤ 6000 мм</div>
            <div id="errL" class="err"></div>
          </div>
        </div>
      </div>

      <div>
        <div class="sectionTitle">Арматура и цена</div>
        <div class="grid two">
          <div>
            <label for="dX">dX (стержни ∥X), мм</label>
            <select id="dX">
              <option value="">Выберите…</option>
              <option value="6">6</option>
              <option value="8">8</option>
              <option value="10">10</option>
              <option value="12">12</option>
            </select>
            <div id="errDX" class="err"></div>
          </div>
          <div>
            <label for="dY">dY (стержни ∥Y), мм</label>
            <select id="dY">
              <option value="">Выберите…</option>
              <option value="6">6</option>
              <option value="8">8</option>
              <option value="10">10</option>
              <option value="12">12</option>
            </select>
            <div id="errDY" class="err"></div>
          </div>

          <div>
            <label for="priceT">Индикативная цена, €/т</label>
            <input id="priceT" type="number" inputmode="decimal" min="0" step="0.01" placeholder="">
            <div id="errPriceT" class="err"></div>
          </div>

          <div class="hint">
            dX относится к стержням вдоль X (длина = L). dY — вдоль Y (длина = W).
          </div>
        </div>
      </div>

      <div>
        <div class="sectionTitle">Шаги</div>
        <div class="grid two">
          <div>
            <label for="Sy">Sy (раскладка по Y), мм</label>
            <select id="Sy" disabled>
              <option value="">Сначала выберите dY…</option>
            </select>
            <div class="hint">Sy ∈ {100,150,200}. Если где-либо Ø12 — шаг 100 запрещён везде.</div>
            <div id="errSy" class="err"></div>
          </div>

          <div>
            <label for="Sx">Sx (раскладка по X), мм</label>
            <select id="Sx" disabled>
              <option value="">Сначала выберите dX…</option>
            </select>
            <div class="hint">Sx ∈ {100,150,200,250,300,350,400,450}. Если где-либо Ø12 — шаг 100 запрещён везде.</div>
            <div id="errSx" class="err"></div>
          </div>
        </div>
      </div>

      <div>
        <div class="sectionTitle">Выпуски (смещение крайних стержней внутрь)</div>
        <div class="grid two">
          <div>
            <label for="Left">Left, <span data-unit-label="len">мм</span></label>
            <input id="Left" type="number" inputmode="decimal" min="0" step="50" placeholder="">
            <div id="errLeft" class="err"></div>
          </div>
          <div>
            <label for="Right">Right, <span data-unit-label="len">мм</span></label>
            <input id="Right" type="number" inputmode="decimal" min="0" step="50" placeholder="">
            <div class="hint">Ограничение: Right ≤ 200 мм</div>
            <div id="errRight" class="err"></div>
          </div>
          <div>
            <label for="Top">Top, <span data-unit-label="len">мм</span></label>
            <input id="Top" type="number" inputmode="decimal" min="0" step="50" placeholder="">
            <div id="errTop" class="err"></div>
          </div>
          <div>
            <label for="Bottom">Bottom, <span data-unit-label="len">мм</span></label>
            <input id="Bottom" type="number" inputmode="decimal" min="0" step="50" placeholder="">
            <div id="errBottom" class="err"></div>
          </div>
        </div>
        <div class="hint">
          Если не заданы — считаем автоматически (минимум 10 мм с каждой стороны).
          Если заданные не влезают — уменьшаем количество стержней (шаг не меняем).
        </div>
      </div>
    </div>

    <div class="btns">
      <button class="primary" id="calcBtn">Рассчитать</button>
      <button id="copyBtn">Копировать результат</button>
      <button id="shareBtn">Ссылка-шэр</button>
      <button id="resetBtn">Сбросить</button>
    </div>

    <div style="margin-top:10px;">
      <button id="fillBtn" style="width:100%;">Заполнить пример</button>
    </div>

    <div id="globalErr" class="err" style="margin-top:10px"></div>

    <div class="results" id="results">
      <hr class="hr">

      <div class="grid two">
        <div class="card" style="border-radius:12px;border:1px solid #eee; box-shadow:none;">
          <div class="sectionTitle">
            <span>Результат</span>
            <span class="pill" id="okBadge">готово</span>
          </div>
          <div class="kv" id="outKV"></div>
          <div class="note">Сетка сварная. Арматура B500A. Значения расчётные.</div>
        </div>

        <div class="card" style="border-radius:12px;border:1px solid #eee; box-shadow:none;">
          <div class="sectionTitle">Предупреждения / диагностика</div>
          <div id="warnings" class="warn"></div>
        </div>
      </div>

      <div class="card" style="margin-top:10px;border-radius:12px;border:1px solid #eee; box-shadow:none;">
        <div class="sectionTitle">Ограничения и правила (перенесено вниз)</div>
        <div class="pillsWrap" id="rulesPills"></div>
        <div class="hint">
          Напоминание: шаг фиксированный. Выпуск длину стержня не увеличивает. Под выпуски — только уменьшаем N.
        </div>
      </div>

      <details>
        <summary>Отладка</summary>
        <pre id="debug" class="hint" style="white-space:pre-wrap"></pre>
      </details>
    </div>

  </div>
</div>

<div class="stickyBar">
  <div class="stickyInner">
    <button class="primary" id="calcBtn2">Рассчитать</button>
    <button id="copyBtn2">Копировать</button>
    <button id="shareBtn2">Шэр</button>
    <div class="mini">На телефоне кнопки всегда под рукой.</div>
  </div>
</div>

<script>
  // ===================== ПРАВИЛА =====================
  const SY_ALL = [100, 150, 200];
  const SX_ALL = [100, 150, 200, 250, 300, 350, 400, 450];

  // Удельные веса (кг/м)
  const KG_PER_M = { 6: 0.222, 8: 0.395, 10: 0.616, 12: 0.888 };

  // Минимальный выпуск с каждой стороны
  const MIN_RELEASE = 10; // мм

  // Ограничение справа
  const MAX_RIGHT = 200; // мм

  // ===================== HELPERS =====================
  const $ = (id) => document.getElementById(id);
  const LS_KEY = "mesh_calc_fixedstep_v2025_12_23_full";

  const toNum = (v) => (v === "" || v === null || v === undefined) ? NaN : Number(v);
  function round(n, d) { const k = 10 ** d; return Math.round(n * k) / k; }

  function unitMode() { return document.querySelector('input[name="u"]:checked').value; }
  function lenToMm(v) {
    const mode = unitMode();
    const n = toNum(v);
    if (!isFinite(n)) return NaN;
    return mode === "mm" ? n : n * 1000;
  }

  function syncUnitLabels() {
    const mode = unitMode();
    document.querySelectorAll('[data-unit-label="len"]').forEach(el => el.textContent = (mode === "mm" ? "мм" : "м"));

    // шаг стрелочек: 50 мм или 0.05 м
    const step = (mode === "mm") ? "50" : "0.05";
    $("W").setAttribute("step", step);
    $("L").setAttribute("step", step);
    ["Left","Right","Top","Bottom"].forEach(id => $(id).setAttribute("step", step));
  }

  function clearErrors() {
    ["errW","errL","errDX","errDY","errSy","errSx","errLeft","errRight","errTop","errBottom","errPriceT","globalErr"]
      .forEach(id => { const el = $(id); if (el) el.textContent = ""; });
  }

  function setKV(el, items) {
    el.innerHTML = "";
    for (const [k, v] of items) {
      const dk = document.createElement("div"); dk.className = "k"; dk.textContent = k;
      const dv = document.createElement("div"); dv.className = "v"; dv.textContent = v;
      el.appendChild(dk); el.appendChild(dv);
    }
  }

  function fillSelect(selectEl, options, placeholder) {
    selectEl.innerHTML = "";
    const o0 = document.createElement("option");
    o0.value = "";
    o0.textContent = placeholder;
    selectEl.appendChild(o0);
    for (const val of options) {
      const o = document.createElement("option");
      o.value = String(val);
      o.textContent = String(val);
      selectEl.appendChild(o);
    }
    selectEl.disabled = false;
  }

  // ===================== ГЛОБАЛЬНОЕ ПРАВИЛО Ø12 =====================
  function isAny12() {
    return Number($("dX").value) === 12 || Number($("dY").value) === 12;
  }
  function allowedStepsGlobal(stepsAll) {
    return isAny12() ? stepsAll.filter(s => s >= 150) : stepsAll.slice();
  }

  function rebuildSteps() {
    const dx = $("dX").value;
    const dy = $("dY").value;

    // Sx доступен только после dX
    if (!dx) {
      $("Sx").innerHTML = `<option value="">Сначала выберите dX…</option>`;
      $("Sx").disabled = true;
      $("Sx").value = "";
    } else {
      const prev = $("Sx").value;
      fillSelect($("Sx"), allowedStepsGlobal(SX_ALL), "Выберите…");
      if (prev && Array.from($("Sx").options).some(o => o.value === prev)) $("Sx").value = prev;
      else $("Sx").value = "";
    }

    // Sy доступен только после dY
    if (!dy) {
      $("Sy").innerHTML = `<option value="">Сначала выберите dY…</option>`;
      $("Sy").disabled = true;
      $("Sy").value = "";
    } else {
      const prev = $("Sy").value;
      fillSelect($("Sy"), allowedStepsGlobal(SY_ALL), "Выберите…");
      if (prev && Array.from($("Sy").options).some(o => o.value === prev)) $("Sy").value = prev;
      else $("Sy").value = "";
    }

    // если где-то Ø12 и был выбран 100 — сбросим
    if (isAny12()) {
      if ($("Sx").value === "100") $("Sx").value = "";
      if ($("Sy").value === "100") $("Sy").value = "";
    }
  }

  // ===================== SOLVER (фикс. шаг, заданные выпуски=МИНИМУМЫ) =====================
  // Для оси размера D и шага S, при N стержнях:
  // span=(N-1)*S, rem=D-span, A+B=rem.
  // Если reqA/reqB заданы — это МИНИМУМЫ. Мы НЕ уменьшаем их.
  // Если не влезают — уменьшаем N. "Лишнее" распределяем, уважая maxA/maxB.
  function solveAxis({ D, S, reqA, reqB, minRelease, maxA, maxB }) {
    let N = Math.floor(D / S) + 1;
    if (N < 2) N = 2;

    const hasA = isFinite(reqA);
    const hasB = isFinite(reqB);

    function distributeExtra(A, B, extra) {
      let a = A, b = B, e = extra;
      if (e <= 1e-12) return { A: a, B: b, extraLeft: 0 };

      // сначала поровну
      let addA = e / 2;
      let addB = e - addA;

      if (maxA != null) addA = Math.min(addA, Math.max(0, maxA - a));
      if (maxB != null) addB = Math.min(addB, Math.max(0, maxB - b));

      a += addA; b += addB;
      e -= (addA + addB);

      // затем докидываем туда, где ещё можно
      if (e > 1e-9 && (maxA == null || a < maxA - 1e-9)) {
        const add = (maxA == null) ? e : Math.min(e, maxA - a);
        a += add; e -= add;
      }
      if (e > 1e-9 && (maxB == null || b < maxB - 1e-9)) {
        const add = (maxB == null) ? e : Math.min(e, maxB - b);
        b += add; e -= add;
      }
      return { A: a, B: b, extraLeft: e };
    }

    while (N >= 2) {
      const span = (N - 1) * S;
      if (span > D) { N--; continue; }

      const rem = D - span; // >=0

      // нужен минимум для обоих краёв
      if (rem < 2 * minRelease) { N--; continue; }

      let A, B;

      if (!hasA && !hasB) {
        // авто: поровну
        A = rem / 2;
        B = rem - A;
      } else if (hasA && !hasB) {
        // A минимум, B остаток
        A = reqA;
        B = rem - A;
      } else if (!hasA && hasB) {
        // B минимум, A остаток
        B = reqB;
        A = rem - B;
      } else {
        // оба заданы как минимумы
        const sumReq = reqA + reqB;
        if (sumReq > rem + 1e-9) { N--; continue; } // не влезает -> уменьшаем N

        A = reqA;
        B = reqB;

        const extra = rem - sumReq;
        const dist = distributeExtra(A, B, extra);
        A = dist.A; B = dist.B;

        // если лишнее некуда положить (из-за max) -> уменьшаем N
        if (dist.extraLeft > 1e-6) { N--; continue; }
      }

      // минимальные выпуски
      if (!(A >= minRelease && B >= minRelease)) { N--; continue; }

      // max ограничения
      if (maxA != null && A > maxA + 1e-9) { N--; continue; }
      if (maxB != null && B > maxB + 1e-9) { N--; continue; }

      return { N, A, B, span, rem };
    }

    return null;
  }

  // ===================== VALIDATION =====================
  function validateInputs(mm) {
    clearErrors();
    let ok = true;
    const bad = (id, msg) => { $(id).textContent = msg; ok = false; };

    if (!(mm.L > 0)) bad("errL", "Введите L");
    if (!(mm.W > 0)) bad("errW", "Введите W");

    if (isFinite(mm.L) && (mm.L < 1000 || mm.L > 6000)) bad("errL", "ТЗ: 1000 ≤ L ≤ 6000 мм");
    if (isFinite(mm.W) && (mm.W < 1200 || mm.W > 2350)) bad("errW", "ТЗ: 1200 ≤ W ≤ 2350 мм");

    if (!(mm.dX > 0)) bad("errDX", "Выберите dX");
    if (!(mm.dY > 0)) bad("errDY", "Выберите dY");

    if (!(mm.Sx > 0)) bad("errSx", "Выберите Sx");
    if (!(mm.Sy > 0)) bad("errSy", "Выберите Sy");

    if (!(mm.priceT >= 0)) bad("errPriceT", "Цена не может быть отрицательной");

    // Пользовательские выпуски: если заданы — >= MIN_RELEASE
    const checkOpt = (val, id, name) => {
      if (val === null) return;
      if (!(val >= 0)) bad(id, `${name}: неотрицательно`);
      else if (val < MIN_RELEASE) bad(id, `${name}: минимум ${MIN_RELEASE} мм`);
    };
    checkOpt(mm.Left, "errLeft", "Left");
    checkOpt(mm.Right, "errRight", "Right");
    checkOpt(mm.Bottom, "errBottom", "Bottom");
    checkOpt(mm.Top, "errTop", "Top");

    // Right <= 200 если задан пользователем
    if (mm.Right !== null && mm.Right > MAX_RIGHT) bad("errRight", `Right ≤ ${MAX_RIGHT} мм`);

    // Если обе стороны заданы — сумма должна быть < размера
    if (mm.Left !== null && mm.Right !== null && (mm.Left + mm.Right >= mm.L)) bad("errLeft", "Left+Right < L");
    if (mm.Top !== null && mm.Bottom !== null && (mm.Top + mm.Bottom >= mm.W)) bad("errTop", "Top+Bottom < W");

    // Глобальное правило Ø12 -> запрет 100 по обеим осям
    if ((mm.dX === 12 || mm.dY === 12) && mm.Sx < 150) bad("errSx", "При наличии Ø12 шаг 100 запрещён (мин 150)");
    if ((mm.dX === 12 || mm.dY === 12) && mm.Sy < 150) bad("errSy", "При наличии Ø12 шаг 100 запрещён (мин 150)");

    return ok;
  }

  // ===================== CALC =====================
  function calc() {
    saveState();

    const mm = {
      L: lenToMm($("L").value),
      W: lenToMm($("W").value),
      dX: toNum($("dX").value),
      dY: toNum($("dY").value),
      Sx: toNum($("Sx").value),
      Sy: toNum($("Sy").value),

      Left:  $("Left").value  === "" ? null : lenToMm($("Left").value),
      Right: $("Right").value === "" ? null : lenToMm($("Right").value),
      Top:   $("Top").value   === "" ? null : lenToMm($("Top").value),
      Bottom:$("Bottom").value=== "" ? null : lenToMm($("Bottom").value),

      priceT: toNum($("priceT").value || 0),
    };

    if (!validateInputs(mm)) { $("results").style.display = "none"; return; }

    // если сторона не задана — считаем как "не задано" (NaN), а минимум MIN_RELEASE обеспечит solver
    const reqLeft   = (mm.Left   === null ? NaN : mm.Left);
    const reqRight  = (mm.Right  === null ? NaN : mm.Right);
    const reqBottom = (mm.Bottom === null ? NaN : mm.Bottom);
    const reqTop    = (mm.Top    === null ? NaN : mm.Top);

    // Ось X: размер L, шаг Sx, выпуски Left/Right (минимумы), Right<=200
    const solX = solveAxis({
      D: mm.L,
      S: mm.Sx,
      reqA: reqLeft,
      reqB: reqRight,
      minRelease: MIN_RELEASE,
      maxB: MAX_RIGHT
    });

    // Ось Y: размер W, шаг Sy, выпуски Bottom/Top (минимумы)
    const solY = solveAxis({
      D: mm.W,
      S: mm.Sy,
      reqA: reqBottom,
      reqB: reqTop,
      minRelease: MIN_RELEASE
    });

    if (!solX || !solY) {
      $("globalErr").textContent =
        "Невозможно разместить стержни при заданных размерах/шагах/выпусках (шаг фиксированный; пробовали уменьшать количество стержней).";
      $("results").style.display = "none";
      return;
    }

    // Количество стержней:
    // NX (∥X) определяется раскладкой по Y (ось Y) => N по оси Y
    // NY (∥Y) определяется раскладкой по X (ось X) => N по оси X
    const NX = solY.N;
    const NY = solX.N;

    // Длины стержней НЕ увеличиваются выпусками
    const lenX_m = mm.L / 1000;
    const lenY_m = mm.W / 1000;

    const wX = KG_PER_M[mm.dX];
    const wY = KG_PER_M[mm.dY];

    const massX = NX * lenX_m * wX;
    const massY = NY * lenY_m * wY;
    const mass = massX + massY;

    const area = (mm.L / 1000) * (mm.W / 1000);
    const kgm2 = area > 0 ? (mass / area) : NaN;

    const priceGrid = (mass / 1000) * mm.priceT;

    const mass_r = round(mass, 1);
    const massX_r = round(massX, 1);
    const massY_r = round(massY, 1);
    const area_r = round(area, 2);
    const kgm2_r = round(kgm2, 2);
    const price_r = round(priceGrid, 2);

    // Фактические выпуски
    const LeftA = solX.A, RightB = solX.B;
    const BottomA = solY.A, TopB = solY.B;

    setKV($("outKV"), [
      ["L / W", `${Math.round(mm.L)} мм / ${Math.round(mm.W)} мм`],
      ["Sx / Sy", `${mm.Sx} мм / ${mm.Sy} мм`],
      ["dX / dY", `${mm.dX} мм / ${mm.dY} мм`],

      ["Кол-во X-стержней (∥X)", `${NX} шт`],
      ["Кол-во Y-стержней (∥Y)", `${NY} шт`],

      ["Факт. выпуски X (Left/Right)", `${round(LeftA,0)} / ${round(RightB,0)} мм`],
      ["Факт. выпуски Y (Bottom/Top)", `${round(BottomA,0)} / ${round(TopB,0)} мм`],

      ["Масса X / Y", `${massX_r} / ${massY_r} кг`],
      ["Масса карты", `${mass_r} кг`],
      ["Площадь", `${area_r} м²`],
      ["Удельная масса", `${kgm2_r} кг/м²`],

      ["Цена, €/т", `${round(mm.priceT,2).toFixed(2)}`],
      ["Цена сетки, €", `${price_r.toFixed(2)}`],
    ]);

    // Warnings / диагностика
    const warn = [];
    if (mm.priceT === 0) warn.push("Цена €/т = 0 → итоговая цена будет 0 (для теста допустимо).");

    const userHadX = (mm.Left !== null || mm.Right !== null);
    const userHadY = (mm.Bottom !== null || mm.Top !== null);

    if (userHadX) {
      // если заданные были, а N пришлось уменьшать — просто фиксируем факт
      warn.push("По оси X: заданные выпуски трактуются как минимумы; при нехватке места уменьшено количество стержней.");
    }
    if (userHadY) {
      warn.push("По оси Y: заданные выпуски трактуются как минимумы; при нехватке места уменьшено количество стержней.");
    }

    if (RightB > MAX_RIGHT + 1e-6) warn.push(`Right получился > ${MAX_RIGHT} мм — это не должно происходить (проверь).`);

    $("warnings").innerHTML = warn.length ? warn.map(x => `• ${x}`).join("<br/>") : `<span class="ok">Похоже на правду.</span>`;

    $("debug").textContent =
`Ввод (мм):
L=${mm.L}, W=${mm.W}
Sx=${mm.Sx}, Sy=${mm.Sy}
dX=${mm.dX}, dY=${mm.dY}
Left=${mm.Left}, Right=${mm.Right}, Bottom=${mm.Bottom}, Top=${mm.Top}
priceT=${mm.priceT}

Ось X (фикс. шаг, уменьшаем N):
N=${solX.N}, span=${solX.span}, rem=${solX.rem}, Left=${solX.A}, Right=${solX.B}

Ось Y (фикс. шаг, уменьшаем N):
N=${solY.N}, span=${solY.span}, rem=${solY.rem}, Bottom=${solY.A}, Top=${solY.B}

Стержни:
NX (∥X) = ${NX}, lenX=${lenX_m}м, wX=${wX}
NY (∥Y) = ${NY}, lenY=${lenY_m}м, wY=${wY}

massX=${massX}, massY=${massY}, mass=${mass}
area=${area}, kg/m²=${kgm2}
priceGrid=${priceGrid}`;

    // Плашки правил — вниз
    $("rulesPills").innerHTML = [
      `Sy ∈ {100,150,200}`,
      `Sx ∈ {100,150,200,250,300,350,400,450}`,
      `Если где-либо Ø12 → шаг 100 запрещён везде`,
      `MIN выпуск = ${MIN_RELEASE} мм (всегда)`,
      `Right ≤ ${MAX_RIGHT} мм`,
      `Шаг не меняем; под выпуски только уменьшаем N`,
      `Выпуск длину стержня не увеличивает`
    ].map(t => `<span class="pill">${t}</span>`).join("");

    $("okBadge").textContent = "готово";
    $("globalErr").textContent = "";
    $("results").style.display = "block";
    $("results").scrollIntoView({behavior: "smooth", block: "start"});
  }

  // ===================== COPY / SHARE / STATE =====================
  function buildCopyText() {
    if ($("results").style.display !== "block") return "Нет результата. Нажмите «Рассчитать».";
    const rows = [];
    rows.push("Калькулятор сварной сетки (фикс. шаг, выпуски=уменьшаем N)");
    rows.push("");
    const el = $("outKV");
    const kids = Array.from(el.children);
    for (let i=0; i<kids.length; i+=2) rows.push(`- ${kids[i].textContent}: ${kids[i+1].textContent}`);
    rows.push("");
    rows.push("Предупреждения:");
    rows.push($("warnings").innerText.trim() || "—");
    rows.push("");
    rows.push("Примечание: Сетка сварная. Арматура B500A. Значения расчётные.");
    return rows.join("\n");
  }

  async function copyResult() {
    const text = buildCopyText();
    try { await navigator.clipboard.writeText(text); alert("Результат скопирован."); }
    catch { prompt("Скопируйте текст:", text); }
  }

  function stateToQuery() {
    const p = new URLSearchParams();
    p.set("u", unitMode());
    ["L","W","dX","dY","Sx","Sy","Left","Right","Bottom","Top","priceT"].forEach(id => p.set(id, $(id).value || ""));
    return p.toString();
  }

  async function shareLink() {
    const url = `${location.origin}${location.pathname}?${stateToQuery()}`;
    try { await navigator.clipboard.writeText(url); alert("Ссылка скопирована."); }
    catch { prompt("Скопируйте ссылку:", url); }
  }

  function saveState() {
    const state = {
      u: unitMode(),
      auto: $("autoCalc").checked,
      L: $("L").value, W: $("W").value,
      dX: $("dX").value, dY: $("dY").value,
      Sx: $("Sx").value, Sy: $("Sy").value,
      Left: $("Left").value, Right: $("Right").value,
      Bottom: $("Bottom").value, Top: $("Top").value,
      priceT: $("priceT").value
    };
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const s = JSON.parse(raw);

      if (s.u) document.querySelector(`input[name="u"][value="${s.u}"]`).checked = true;
      $("autoCalc").checked = !!s.auto;

      ["L","W","Left","Right","Bottom","Top","priceT"].forEach(k => { if (s[k] !== undefined) $(k).value = s[k]; });
      if (s.dX !== undefined) $("dX").value = s.dX;
      if (s.dY !== undefined) $("dY").value = s.dY;

      syncUnitLabels();
      rebuildSteps();

      if (s.Sx !== undefined) $("Sx").value = s.Sx;
      if (s.Sy !== undefined) $("Sy").value = s.Sy;

      // если теперь нельзя 100 — сбросим
      if (isAny12()) {
        if ($("Sx").value === "100") $("Sx").value = "";
        if ($("Sy").value === "100") $("Sy").value = "";
      }
    } catch {}
  }

  function applyQuery() {
    const p = new URLSearchParams(location.search);
    if (!p.size) return;

    const u = p.get("u");
    if (u === "mm" || u === "m") document.querySelector(`input[name="u"][value="${u}"]`).checked = true;

    ["L","W","Left","Right","Bottom","Top","priceT"].forEach(id => {
      const v = p.get(id);
      if (v !== null) $(id).value = v;
    });

    const dX = p.get("dX"); if (dX !== null) $("dX").value = dX;
    const dY = p.get("dY"); if (dY !== null) $("dY").value = dY;

    syncUnitLabels();
    rebuildSteps();

    const Sx = p.get("Sx"); if (Sx !== null) $("Sx").value = Sx;
    const Sy = p.get("Sy"); if (Sy !== null) $("Sy").value = Sy;

    // если по ссылке пришёл 100, а теперь нельзя — сбросим
    if (isAny12()) {
      if ($("Sx").value === "100") $("Sx").value = "";
      if ($("Sy").value === "100") $("Sy").value = "";
    }
  }

  function resetAll() {
    ["L","W","Left","Right","Bottom","Top","priceT"].forEach(id => $(id).value = "");
    $("dX").value = "";
    $("dY").value = "";
    rebuildSteps();
    $("results").style.display = "none";
    clearErrors();
    $("globalErr").textContent = "";
    localStorage.removeItem(LS_KEY);
    if (location.search) history.replaceState({}, "", location.pathname);
  }

  function fillExample() {
    document.querySelector('input[name="u"][value="mm"]').checked = true;
    syncUnitLabels();

    $("W").value = 1200;
    $("L").value = 2000;

    $("dX").value = "8";
    $("dY").value = "6";
    rebuildSteps();

    $("Sx").value = "150";
    $("Sy").value = "150";

    // Пусто = авто; авто учтёт MIN_RELEASE=10
    $("Left").value = "";
    $("Right").value = "";
    $("Bottom").value = "";
    $("Top").value = "";

    $("priceT").value = "700";

    $("results").style.display = "none";
    clearErrors();
    saveState();
  }

  // ===================== WIRING =====================
  function maybeAutoCalc() {
    if ($("autoCalc").checked) calc();
    else saveState();
  }

  $("dX").addEventListener("change", () => { rebuildSteps(); maybeAutoCalc(); });
  $("dY").addEventListener("change", () => { rebuildSteps(); maybeAutoCalc(); });

  ["L","W","Sx","Sy","Left","Right","Bottom","Top","priceT"].forEach(id => {
    $(id).addEventListener("input", maybeAutoCalc);
    $(id).addEventListener("change", maybeAutoCalc);
  });

  document.querySelectorAll('input[name="u"]').forEach(r => r.addEventListener("change", () => { syncUnitLabels(); maybeAutoCalc(); }));
  $("autoCalc").addEventListener("change", saveState);

  $("calcBtn").addEventListener("click", calc);
  $("calcBtn2").addEventListener("click", calc);

  $("copyBtn").addEventListener("click", copyResult);
  $("copyBtn2").addEventListener("click", copyResult);

  $("shareBtn").addEventListener("click", shareLink);
  $("shareBtn2").addEventListener("click", shareLink);

  $("resetBtn").addEventListener("click", resetAll);
  $("fillBtn").addEventListener("click", () => { fillExample(); calc(); });

  document.addEventListener("keydown", (e) => { if (e.key === "Enter") calc(); });

  // init
  syncUnitLabels();
  rebuildSteps();
  loadState();
  applyQuery();
</script>
</body>
</html>
